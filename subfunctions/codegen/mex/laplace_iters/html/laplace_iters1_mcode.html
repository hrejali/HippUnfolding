<html>
<body>
<script src="resources/eml_report_loadable_data.js"></script>
<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,1" id="srcline1"> 1</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S2T1U3">LP</span>, <span class="var type1" id="S3T2U4">iter_change</span>] = laplace_iters(<span class="var type1" id="S4T3U7">fg</span>,<span class="var type1" id="S5T3U8">source</span>,<span class="var type1" id="S6T3U9">sink</span>,<span class="var type1" id="S7T4U10">init</span>,<span class="var type1" id="S8T5U11">maxiters</span>,<span class="var type1" id="S9T6U12">sz</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,2" id="srcline2"> 2</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,3" id="srcline3"> 3</a></span><span class="line"><span class="mxinfo " id="T5:U9"><span class="var type1" id="S10T5U15">change_threshold</span> = <span class="mxinfo " id="T5:U11"><span class="mxinfo " id="T5:U12">10</span>^(-3)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,4" id="srcline4"> 4</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,5" id="srcline5"> 5</a></span><span class="line"><span class="comment">%filter set-up (26 nearest neighbours)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,6" id="srcline6"> 6</a></span><span class="line"><span class="mxinfo " id="T7:U13"><span class="var type1" id="S11T7U23">hl</span>=<span class="mxinfo " id="T7:U15">ones(<span class="mxinfo " id="T5:U16">3</span>,<span class="mxinfo " id="T5:U17">3</span>,<span class="mxinfo " id="T5:U18">3</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,7" id="srcline7"> 7</a></span><span class="line"><span class="comment">% filter set-up (6 NN) (safer, especially in cases of coronal non-oblique</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,8" id="srcline8"> 8</a></span><span class="line"><span class="comment">% where dark band is more likely to 'leak' across diagonals</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,9" id="srcline9"> 9</a></span><span class="line"><span class="comment">% hl = strel('sphere',1);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,10" id="srcline10">10</a></span><span class="line"><span class="comment">% hl = double(hl.Neighborhood);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,11" id="srcline11">11</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,12" id="srcline12">12</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,13" id="srcline13">13</a></span><span class="line"><span class="mxinfo " id="T2:U19"><span class="var type1" id="S13T2U31">elems</span> = <span class="mxinfo " id="T2:U21">1: <span class="mxinfo " id="T5:U22"><span class="mxinfo " id="T5:U23"><span class="mxinfo " id="T5:U24"><span class="var type1" id="S9T6U37">sz</span>(<span class="mxinfo " id="T8:U26">1</span>)</span>*<span class="mxinfo " id="T5:U27"><span class="var type1" id="S9T6U40">sz</span>(<span class="mxinfo " id="T5:U29">2</span>)</span></span>*<span class="mxinfo " id="T5:U30"><span class="var type1" id="S9T6U43">sz</span>(<span class="mxinfo " id="T5:U32">3</span>)</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,14" id="srcline14">14</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,15" id="srcline15">15</a></span><span class="line"><span class="comment">%set up all requisite variables</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,16" id="srcline16">16</a></span><span class="line"><span class="mxinfo " id="T1:U33"><span class="var type1" id="S14T1U47">vel</span> = <span class="mxinfo " id="T1:U35">nan(<span class="var type1" id="S9T6U50">sz</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,17" id="srcline17">17</a></span><span class="line"><span class="mxinfo " id="T3:U37"><span class="mxinfo " id="T3:U38"><span class="var type1" id="S14T1U54">vel</span>(<span class="var type1" id="S4T3U55">fg</span>)</span>=<span class="var type1" id="S7T4U56">init</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,18" id="srcline18">18</a></span><span class="line"><span class="mxinfo " id="T3:U42"><span class="mxinfo " id="T3:U43"><span class="var type1" id="S14T1U60">vel</span>(<span class="var type1" id="S5T3U61">source</span>)</span>=<span class="mxinfo " id="T5:U46">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,19" id="srcline19">19</a></span><span class="line"><span class="mxinfo " id="T3:U47"><span class="mxinfo " id="T3:U48"><span class="var type1" id="S14T1U66">vel</span>(<span class="var type1" id="S6T3U67">sink</span>)</span>=<span class="mxinfo " id="T5:U51">1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,20" id="srcline20">20</a></span><span class="line"><span class="mxinfo " id="T2:U52"><span class="var type1" id="S16T2U71">bg</span> = (<span class="mxinfo " id="T2:U54">setdiff(<span class="var type1" id="S13T2U75">elems</span>,<span class="mxinfo " id="T3:U56">sort(<span class="mxinfo " id="T3:U57">[<span class="var type1" id="S4T3U80">fg</span>;<span class="var type1" id="S5T3U82">source</span>;<span class="var type1" id="S6T3U84">sink</span>]</span>)</span>)</span>)</span>; <span class="comment">% bg in logical</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,21" id="srcline21">21</a></span><span class="line"><span class="mxinfo " id="T2:U61"><span class="mxinfo " id="T2:U62"><span class="var type1" id="S14T1U88">vel</span>(<span class="var type1" id="S16T2U89">bg</span>)</span>=<span class="mxinfo " id="T5:U65">0</span></span>; <span class="comment">%must be insulated after filtering</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,22" id="srcline22">22</a></span><span class="line"><span class="mxinfo " id="T2:U66"><span class="var type1" id="S3T2U93">iter_change</span> = <span class="mxinfo " id="T2:U68">zeros(<span class="mxinfo " id="T5:U69">1</span>,<span class="var type1" id="S8T5U97">maxiters</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,23" id="srcline23">23</a></span><span class="line"><span class="mxinfo " id="T1:U71"><span class="var type1" id="S20T1U100">insulate_correction</span> = <span class="mxinfo " id="T1:U73">zeros(<span class="var type1" id="S9T6U103">sz</span>)</span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="1,24" id="srcline24">24</a></span><span class="line"><span class="mxinfo " id="T3:U75"><span class="mxinfo " id="T3:U76"><span class="var type1" id="S20T1U107">insulate_correction</span>(<span class="mxinfo " id="T3:U78">[<span class="var type1" id="S4T3U110">fg</span>;<span class="var type1" id="S5T3U112">source</span>;<span class="var type1" id="S6T3U114">sink</span>]</span>)</span> = <span class="mxinfo " id="T5:U82">1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,25" id="srcline25">25</a></span><span class="line"><span class="mxinfo " id="T1:U83"><span class="var type1" id="S20T1U118">insulate_correction</span> = <span class="mxinfo " id="T1:U85">imfilter(<span class="var type1" id="S20T1U121">insulate_correction</span>,<span class="var type1" id="S11T7U122">hl</span>,<span class="string">'replicate'</span>,<span class="string">'conv'</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,26" id="srcline26">26</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,27" id="srcline27">27</a></span><span class="line"><span class="comment">% apply filter</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,28" id="srcline28">28</a></span><span class="line"><span class="mxinfo " id="T5:U88"><span class="var type1" id="S22T5U127">iters</span> = <span class="mxinfo " id="T5:U90">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,29" id="srcline29">29</a></span><span class="line"><span class="keyword">while</span> <span class="mxinfo " id="T9:U91"><span class="var type1" id="S22T5U131">iters</span> &lt; <span class="var type1" id="S8T5U132">maxiters</span></span> <span class="comment">%max iterations</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,30" id="srcline30">30</a></span><span class="line">    <span class="mxinfo " id="T5:U94"><span class="var type1" id="S22T5U135">iters</span> = <span class="mxinfo " id="T5:U96"><span class="var type1" id="S22T5U137">iters</span>+<span class="mxinfo " id="T5:U98">1</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,31" id="srcline31">31</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,32" id="srcline32">32</a></span><span class="line">    <span class="mxinfo " id="T1:U99"><span class="var type1" id="S23T1U141">velup</span> = <span class="mxinfo " id="T1:U101">imfilter(<span class="var type1" id="S14T1U144">vel</span>,<span class="var type1" id="S11T7U145">hl</span>,<span class="string">'replicate'</span>,<span class="string">'conv'</span>)</span></span>; <span class="comment">%apply averaging filter</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,33" id="srcline33">33</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,34" id="srcline34">34</a></span><span class="line">    <span class="comment">%insulate the grey matter so gradient doesn't pass between folds -</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,35" id="srcline35">35</a></span><span class="line">    <span class="comment">%inspired by ndnanfilter</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,36" id="srcline36">36</a></span><span class="line">    <span class="mxinfo " id="T1:U104"><span class="var type1" id="S23T1U150">velup</span> = <span class="mxinfo " id="T1:U106"><span class="var type1" id="S23T1U152">velup</span>./<span class="var type1" id="S20T1U153">insulate_correction</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,37" id="srcline37">37</a></span><span class="line">    <span class="mxinfo " id="T2:U109"><span class="mxinfo " id="T2:U110"><span class="var type1" id="S23T1U157">velup</span>(<span class="var type1" id="S16T2U158">bg</span>)</span> = <span class="mxinfo " id="T5:U113">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,38" id="srcline38">38</a></span><span class="line">    <span class="mxinfo " id="T3:U114"><span class="mxinfo " id="T3:U115"><span class="var type1" id="S23T1U163">velup</span>(<span class="var type1" id="S5T3U164">source</span>)</span> = <span class="mxinfo " id="T5:U118">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,39" id="srcline39">39</a></span><span class="line">    <span class="mxinfo " id="T3:U119"><span class="mxinfo " id="T3:U120"><span class="var type1" id="S23T1U169">velup</span>(<span class="var type1" id="S6T3U170">sink</span>)</span> = <span class="mxinfo " id="T5:U123">1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,40" id="srcline40">40</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,41" id="srcline41">41</a></span><span class="line">    <span class="comment">%stopping condition</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,42" id="srcline42">42</a></span><span class="line">    <span class="mxinfo " id="T5:U124"><span class="mxinfo " id="T5:U125"><span class="var type1" id="S3T2U175">iter_change</span>(<span class="var type1" id="S22T5U176">iters</span>)</span> = <span class="mxinfo " id="T5:U128">nansum(<span class="mxinfo " id="T3:U129">abs(<span class="mxinfo " id="T3:U130"><span class="mxinfo " id="T3:U131"><span class="var type1" id="S14T1U183">vel</span>(<span class="var type1" id="S4T3U184">fg</span>)</span>-<span class="mxinfo " id="T3:U134"><span class="var type1" id="S23T1U186">velup</span>(<span class="var type1" id="S4T3U187">fg</span>)</span></span>)</span>)</span></span>; <span class="comment">%compute change from last iteration</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,43" id="srcline43">43</a></span><span class="line">    <span class="mxinfo " id="T1:U137"><span class="var type1" id="S14T1U190">vel</span> = <span class="var type1" id="S23T1U191">velup</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,44" id="srcline44">44</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo " id="T9:U140"><span class="mxinfo " id="T5:U141"><span class="var type1" id="S3T2U196">iter_change</span>(<span class="var type1" id="S22T5U197">iters</span>)</span>&lt;<span class="var type1" id="S10T5U198">change_threshold</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,45" id="srcline45">45</a></span><span class="line">        <span class="keyword">break</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,46" id="srcline46">46</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,47" id="srcline47">47</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,48" id="srcline48">48</a></span><span class="line"><span class="mxinfo " id="T1:U145"><span class="var type1" id="S14T1U202">vel</span> = <span class="mxinfo " id="T1:U147"><span class="var type1" id="S14T1U204">vel</span>./<span class="mxinfo " id="T5:U149">max(<span class="mxinfo " id="T3:U150"><span class="var type1" id="S14T1U208">vel</span>(:)</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,49" id="srcline49">49</a></span><span class="line"><span class="mxinfo " id="T3:U152"><span class="mxinfo " id="T3:U153"><span class="var type1" id="S14T1U213">vel</span>(<span class="mxinfo " id="T10:U155">~<span class="var type1" id="S4T3U215">fg</span></span>)</span> = <span class="mxinfo " id="T5:U157">nan</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,50" id="srcline50">50</a></span><span class="line"><span class="mxinfo " id="T1:U158"><span class="var type1" id="S2T1U220">LP</span> = <span class="var type1" id="S14T1U221">vel</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,51" id="srcline51">51</a></span><span class="line"><span class="keyword">end</span></span></span>
</pre>
</body>
</html>
