<html>
<body>
<script src="resources/eml_report_loadable_data.js"></script>
<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,1" id="srcline1"> 1</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S2T1U3">LP</span>, <span class="var type1" id="S3T2U4">iter_change</span>] = laplace_iters(<span class="var type1" id="S4T3U7">source</span>,<span class="var type1" id="S5T3U8">sink</span>,<span class="var type1" id="S6T1U9">init</span>,<span class="var type1" id="S7T4U10">maxiters</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,2" id="srcline2"> 2</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,3" id="srcline3"> 3</a></span><span class="line"><span class="comment">% iterative averaging filter to solve Laplace equation with greater</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,4" id="srcline4"> 4</a></span><span class="line"><span class="comment">% accuracy than initial fast-marching</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,5" id="srcline5"> 5</a></span><span class="line"><span class="mxinfo " id="T5:U7"><span class="var type1" id="S8T5U13">fg</span> = (<span class="mxinfo " id="T5:U9"><span class="mxinfo " id="T6:U10"><span class="var type1" id="S6T1U17">init</span>(:)</span>&gt;=<span class="mxinfo " id="T4:U12">0</span></span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,6" id="srcline6"> 6</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,7" id="srcline7"> 7</a></span><span class="line"><span class="mxinfo " id="T4:U13"><span class="var type1" id="S9T4U22">total_vol</span> = <span class="mxinfo " id="T4:U15">sum(<span class="mxinfo " id="T5:U16"><span class="var type1" id="S8T5U26">fg</span>(:)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,8" id="srcline8"> 8</a></span><span class="line"><span class="mxinfo " id="T4:U18"><span class="var type1" id="S11T4U30">change_threshold</span> = <span class="mxinfo " id="T4:U20"><span class="var type1" id="S9T4U32">total_vol</span>/<span class="mxinfo " id="T4:U22">100000</span></span></span>; <span class="comment">%change threshold should depend on total volume - greater volumes require more</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,9" id="srcline9"> 9</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,10" id="srcline10">10</a></span><span class="line"><span class="comment">%filter set-up (26 nearest neighbours)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,11" id="srcline11">11</a></span><span class="line"><span class="mxinfo " id="T7:U23"><span class="var type1" id="S12T7U36">hl</span>=<span class="mxinfo " id="T7:U25">ones(<span class="mxinfo " id="T4:U26">3</span>,<span class="mxinfo " id="T4:U27">3</span>,<span class="mxinfo " id="T4:U28">3</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,12" id="srcline12">12</a></span><span class="line"><span class="mxinfo " id="T4:U29"><span class="var type1" id="S14T4U44">nelem</span>=<span class="mxinfo " id="T4:U31">numel(<span class="var type1" id="S12T7U47">hl</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,13" id="srcline13">13</a></span><span class="line"><span class="mxinfo " id="T7:U33"><span class="var type1" id="S12T7U50">hl</span>=<span class="mxinfo " id="T7:U35"><span class="var type1" id="S12T7U52">hl</span>./<span class="var type1" id="S14T4U53">nelem</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,14" id="srcline14">14</a></span><span class="line"><span class="mxinfo " id="T7:U38"><span class="var type1" id="S12T7U56">hl</span>=<span class="mxinfo " id="T7:U40"><span class="var type1" id="S12T7U58">hl</span>+<span class="var type1" id="S12T7U61">hl</span>(2,2,2)./(<span class="var type1" id="S14T4U67">nelem</span>-1)</span></span>; <span class="mxinfo " id="T4:U44"><span class="mxinfo " id="T4:U45"><span class="var type1" id="S12T7U72">hl</span>(<span class="mxinfo " id="T8:U47">2</span>,<span class="mxinfo " id="T8:U48">2</span>,<span class="mxinfo " id="T8:U49">2</span>)</span>=<span class="mxinfo " id="T4:U50">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,15" id="srcline15">15</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,16" id="srcline16">16</a></span><span class="line"><span class="mxinfo " id="T3:U51"><span class="var type1" id="S16T3U79">bg</span>=(<span class="mxinfo " id="T3:U53"><span class="mxinfo " id="T3:U54"><span class="mxinfo " id="T3:U55">~<span class="var type1" id="S4T3U84">source</span></span> &amp; <span class="mxinfo " id="T3:U57">~<span class="var type1" id="S5T3U86">sink</span></span></span> &amp; <span class="mxinfo " id="T3:U59">isnan(<span class="var type1" id="S6T1U89">init</span>)</span></span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,17" id="srcline17">17</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,18" id="srcline18">18</a></span><span class="line"><span class="comment">%set up vel</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,19" id="srcline19">19</a></span><span class="line"><span class="mxinfo " id="T1:U61"><span class="var type1" id="S18T1U92">vel</span>=<span class="var type1" id="S6T1U93">init</span></span>; <span class="comment">%geodist to initialize greymatter</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,20" id="srcline20">20</a></span><span class="line"><span class="mxinfo " id="T6:U64"><span class="mxinfo " id="T6:U65"><span class="var type1" id="S18T1U97">vel</span>(<span class="var type1" id="S4T3U98">source</span>)</span>=<span class="mxinfo " id="T4:U68">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,21" id="srcline21">21</a></span><span class="line"><span class="mxinfo " id="T6:U69"><span class="mxinfo " id="T6:U70"><span class="var type1" id="S18T1U103">vel</span>(<span class="var type1" id="S5T3U104">sink</span>)</span>=<span class="mxinfo " id="T4:U73">1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,22" id="srcline22">22</a></span><span class="line"><span class="mxinfo " id="T6:U74"><span class="mxinfo " id="T6:U75"><span class="var type1" id="S18T1U109">vel</span>(<span class="var type1" id="S16T3U110">bg</span>)</span>=<span class="mxinfo " id="T4:U78">0</span></span>; <span class="comment">%must be insulated after filtering</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,23" id="srcline23">23</a></span><span class="line"><span class="mxinfo " id="T2:U79"><span class="var type1" id="S3T2U114">iter_change</span> = <span class="mxinfo " id="T2:U81">zeros(<span class="mxinfo " id="T4:U82">1</span>,<span class="var type1" id="S7T4U118">maxiters</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,24" id="srcline24">24</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,25" id="srcline25">25</a></span><span class="line"><span class="comment">% apply filter</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,26" id="srcline26">26</a></span><span class="line"><span class="mxinfo " id="T4:U84"><span class="var type1" id="S20T4U121">iters</span> = <span class="mxinfo " id="T4:U86">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,27" id="srcline27">27</a></span><span class="line"><span class="keyword">while</span> <span class="mxinfo " id="T9:U87"><span class="var type1" id="S20T4U125">iters</span> &lt; <span class="var type1" id="S7T4U126">maxiters</span></span> <span class="comment">%max iterations</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,28" id="srcline28">28</a></span><span class="line">    <span class="mxinfo " id="T4:U90"><span class="var type1" id="S20T4U129">iters</span> = <span class="mxinfo " id="T4:U92"><span class="var type1" id="S20T4U131">iters</span>+<span class="mxinfo " id="T4:U94">1</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,29" id="srcline29">29</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,30" id="srcline30">30</a></span><span class="line">    <span class="mxinfo " id="T1:U95"><span class="var type1" id="S21T1U135">velup</span> = <span class="mxinfo " id="T1:U97">imfilter(<span class="var type1" id="S18T1U138">vel</span>,<span class="var type1" id="S12T7U139">hl</span>,<span class="string">'replicate'</span>,<span class="string">'conv'</span>)</span></span>; <span class="comment">%apply averaging filter</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,31" id="srcline31">31</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,32" id="srcline32">32</a></span><span class="line">    <span class="comment">%insulate the grey matter so gradient doesn't pass between folds -</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,33" id="srcline33">33</a></span><span class="line">    <span class="comment">%inspired by ndnanfilter</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,34" id="srcline34">34</a></span><span class="line">    <span class="mxinfo " id="T1:U100"><span class="var type1" id="S23T1U144">insulate_correction</span> = <span class="mxinfo " id="T1:U102">imfilter(<span class="mxinfo " id="T1:U103">double(<span class="mxinfo " id="T3:U104">~<span class="var type1" id="S16T3U150">bg</span></span>)</span>,<span class="var type1" id="S12T7U151">hl</span>,<span class="string">'replicate'</span>,<span class="string">'conv'</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,35" id="srcline35">35</a></span><span class="line">    <span class="mxinfo " id="T1:U107"><span class="var type1" id="S21T1U156">velup</span> = <span class="mxinfo " id="T1:U109"><span class="var type1" id="S21T1U158">velup</span>./<span class="var type1" id="S23T1U159">insulate_correction</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,36" id="srcline36">36</a></span><span class="line">    <span class="mxinfo " id="T6:U112"><span class="mxinfo " id="T6:U113"><span class="var type1" id="S21T1U163">velup</span>(<span class="mxinfo " id="T3:U115"><span class="var type1" id="S16T3U165">bg</span>|<span class="var type1" id="S4T3U166">source</span></span>)</span>=<span class="mxinfo " id="T4:U118">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,37" id="srcline37">37</a></span><span class="line">    <span class="mxinfo " id="T6:U119"><span class="mxinfo " id="T6:U120"><span class="var type1" id="S21T1U171">velup</span>(<span class="var type1" id="S5T3U172">sink</span>)</span>=<span class="mxinfo " id="T4:U123">1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,38" id="srcline38">38</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,39" id="srcline39">39</a></span><span class="line">    <span class="comment">%stopping condition</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,40" id="srcline40">40</a></span><span class="line">    <span class="mxinfo " id="T4:U124"><span class="mxinfo " id="T4:U125"><span class="var type1" id="S3T2U177">iter_change</span>(<span class="var type1" id="S20T4U178">iters</span>)</span> = <span class="mxinfo " id="T4:U128">nansum(<span class="mxinfo " id="T6:U129">abs(<span class="mxinfo " id="T6:U130"><span class="mxinfo " id="T6:U131"><span class="var type1" id="S18T1U185">vel</span>(<span class="var type1" id="S8T5U186">fg</span>)</span>-<span class="mxinfo " id="T6:U134"><span class="var type1" id="S21T1U188">velup</span>(<span class="var type1" id="S8T5U189">fg</span>)</span></span>)</span>)</span></span>; <span class="comment">%compute change from last iteration</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,41" id="srcline41">41</a></span><span class="line">    <span class="mxinfo " id="T1:U137"><span class="var type1" id="S18T1U192">vel</span> = <span class="var type1" id="S21T1U193">velup</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,42" id="srcline42">42</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo " id="T9:U140"><span class="mxinfo " id="T4:U141"><span class="var type1" id="S3T2U198">iter_change</span>(<span class="var type1" id="S20T4U199">iters</span>)</span>&lt;<span class="var type1" id="S11T4U200">change_threshold</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,43" id="srcline43">43</a></span><span class="line">        <span class="keyword">break</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,44" id="srcline44">44</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,45" id="srcline45">45</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,46" id="srcline46">46</a></span><span class="line"><span class="mxinfo " id="T1:U145"><span class="var type1" id="S18T1U204">vel</span> = <span class="mxinfo " id="T1:U147"><span class="var type1" id="S18T1U206">vel</span>./<span class="mxinfo " id="T4:U149">max(<span class="mxinfo " id="T6:U150"><span class="var type1" id="S18T1U210">vel</span>(:)</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,47" id="srcline47">47</a></span><span class="line"><span class="mxinfo " id="T6:U152"><span class="mxinfo " id="T6:U153"><span class="var type1" id="S18T1U215">vel</span>(<span class="mxinfo " id="T5:U155">~<span class="var type1" id="S8T5U217">fg</span></span>)</span> = <span class="mxinfo " id="T4:U157">nan</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,48" id="srcline48">48</a></span><span class="line"><span class="mxinfo " id="T1:U158"><span class="var type1" id="S2T1U222">LP</span> = <span class="var type1" id="S18T1U223">vel</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,49" id="srcline49">49</a></span><span class="line"><span class="keyword">end</span></span></span>
</pre>
</body>
</html>
